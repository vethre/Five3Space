<!DOCTYPE html>
<html lang="{{.Lang}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customization</title>
    <style>
        /* ... (Styles remain the same) ... */
        :root {
            --bg-dark: #0f0502;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.5);
            --font-main: "Segoe UI", sans-serif;
            --primary: #ff4500;
        }
        body {
            margin:0; font-family: var(--font-main); background: var(--bg-dark); color: var(--text-main);
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000 100%);
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .top-bar { display:flex; justify-content:space-between; margin-bottom:30px; border-bottom:1px solid var(--glass-border); padding-bottom:20px; }
        .brand { font-weight:900; font-size:1.2rem; color:#888; }
        .brand span { color:var(--primary); }
        .pill-btn { padding:10px 20px; border-radius:999px; background:rgba(255,255,255,0.1); color:white; text-decoration:none; font-weight:bold; }

        .preview-section {
            background: linear-gradient(180deg, rgba(0,0,0,0.5), transparent);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 80px 20px;
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        
        .preview-section.banner-gold { background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%); box-shadow: 0 0 50px rgba(255,215,0,0.2); }
        .preview-section.banner-cyber { background: linear-gradient(135deg, #00f260 0%, #0575e6 100%); }
        .preview-section.banner-default { background: linear-gradient(180deg, rgba(255,69,0,0.1), transparent); }

        .avatar-container { position: relative; width: 140px; height: 140px; margin: 0 auto; cursor: pointer; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; border: 5px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.5); object-fit: cover; }
        .avatar-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
        .avatar-container:hover .avatar-overlay { opacity: 1; }
        .avatar-icon { color: white; font-size: 2rem; }
        
        .preview-name { font-size: 3rem; font-weight: 900; margin-top: 15px; }
        
        .name-white { color: white; }
        .name-gold { color: #ffd700; text-shadow: 0 2px 10px rgba(255,215,0,0.5); }
        .name-rainbow { background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .control-group { background: var(--glass-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border); }
        .control-group h3 { margin-top: 0; color: #ccc; }
        
        .option {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            border: 1px solid #333; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: 0.2s;
        }
        .option:hover { background: rgba(255,255,255,0.05); }
        .option.active { border-color: var(--primary); background: rgba(255,69,0,0.1); }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; }

        .save-bar { position: sticky; bottom: 20px; background: #222; padding: 15px; border-radius: 12px; display: flex; justify-content: flex-end; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-top: 20px; border: 1px solid #444; }
        .save-btn { background: var(--primary); color: black; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 900; cursor: pointer; font-size: 1rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <div class="brand">{{.Text.LobbyName}} <span>/ Customize</span></div>
            <a href="/?lang={{.Lang}}&userID={{.User.ID}}" class="pill-btn">Back</a>
        </div>

        <!-- Live Preview -->
        <div class="preview-section banner-{{.User.BannerColor}}" id="preview-box">
            <div class="avatar-container" onclick="document.getElementById('file-upload').click()">
                <img class="avatar" id="avatar-img" src="{{.User.AvatarURL}}">
                <div class="avatar-overlay">
                    <span class="avatar-icon">ðŸ“·</span>
                </div>
            </div>
            <input type="file" id="file-upload" style="display: none;" accept="image/*">
            
            <div class="preview-name name-{{.User.NameColor}}" id="preview-name">{{.User.Nickname}}</div>
            <div style="color:white; opacity:0.7; font-weight:bold; margin-top:5px; letter-spacing: 2px;">PREVIEW</div>
        </div>

        <div class="controls">
            <!-- Name Color Selector -->
            <div class="control-group">
                <h3>Name Color</h3>
                <div class="option {{if eq .User.NameColor "white"}}active{{end}}" onclick="selectName('white', this)">
                    <div class="color-dot" style="background:white"></div> Standard White
                </div>
                <div class="option {{if eq .User.NameColor "gold"}}active{{end}}" onclick="selectName('gold', this)">
                    <div class="color-dot" style="background:gold"></div> Gold
                </div>
                <div class="option {{if eq .User.NameColor "rainbow"}}active{{end}}" onclick="selectName('rainbow', this)">
                    <div class="color-dot" style="background:linear-gradient(90deg, red, blue)"></div> Rainbow
                </div>
            </div>

            <!-- Banner Selector -->
            <div class="control-group">
                <h3>Lobby Banner</h3>
                <div class="option {{if eq .User.BannerColor "default"}}active{{end}}" onclick="selectBanner('default', this)">
                    <div class="color-dot" style="background:#333"></div> Default Dark
                </div>
                <div class="option {{if eq .User.BannerColor "gold"}}active{{end}}" onclick="selectBanner('gold', this)">
                    <div class="color-dot" style="background:gold"></div> Golden Glow
                </div>
                <div class="option {{if eq .User.BannerColor "cyber"}}active{{end}}" onclick="selectBanner('cyber', this)">
                    <div class="color-dot" style="background:cyan"></div> Cyber Punk
                </div>
            </div>
        </div>

        <div class="save-bar">
            <button class="save-btn" onclick="saveProfile()">Save Changes</button>
        </div>
    </div>

    <script>
        let currentName = '{{.User.NameColor}}';
        let currentBanner = '{{.User.BannerColor}}';
        let newAvatarBase64 = "";

        function selectName(val, el) {
            currentName = val;
            document.querySelectorAll('.control-group:first-child .option').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            const prev = document.getElementById('preview-name');
            prev.className = 'preview-name name-' + val;
        }

        function selectBanner(val, el) {
            currentBanner = val;
            document.querySelectorAll('.control-group:last-child .option').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            const prev = document.getElementById('preview-box');
            prev.className = 'preview-section banner-' + val;
        }

        // Handle File Upload
        const fileInput = document.getElementById('file-upload');
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert("File too large! Max 5MB.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // Resize to max 200x200 to save DB space
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_SIZE = 200;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_SIZE) {
                            height *= MAX_SIZE / width;
                            width = MAX_SIZE;
                        }
                    } else {
                        if (height > MAX_SIZE) {
                            width *= MAX_SIZE / height;
                            height = MAX_SIZE;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    newAvatarBase64 = canvas.toDataURL('image/jpeg', 0.8); // Compress
                    document.getElementById('avatar-img').src = newAvatarBase64;
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        async function saveProfile() {
            try {
                const payload = { 
                    name_color: currentName, 
                    banner_color: currentBanner
                };
                if (newAvatarBase64) {
                    payload.custom_avatar = newAvatarBase64;
                }

                const res = await fetch('/customize/save?userID={{.User.ID}}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                if(res.ok) {
                    alert("Saved!");
                    window.location.href = '/?lang={{.Lang}}&userID={{.User.ID}}';
                }
                else {
                    const errText = await res.text();
                    alert("Error saving: " + errText);
                }
            } catch(e) { alert("Network error: " + e.message); }
        }
    </script>
</body>
</html>